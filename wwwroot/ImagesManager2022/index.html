<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="icon" href="favicon.ico">
</head>

<body>

    <div class="mainContainer">
        <div>

        </div>
        <div class="headerPanel">
            <div class="headerLayout">
                <!-- <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon" title="Gestionnaire d'images"> -->
                <!-- <div style="display:flex"> -->
                <img id="logo" draggable="false" src="images/camera.png" alt="" data-toggle="tooltip" class="favicon"
                    title="Gestionnaire d'Images">
                <div style="display:flex; user-select: none;">
                    <span class="header outLinedText tbg-yellow">

                        P
                    </span>
                    <span class="header outLinedText tbg-orange">
                        I
                    </span>
                    <span class="header outLinedText tbg-red">
                        C
                    </span>
                    <span class="header outLinedText tbg-pink ">
                        T
                    </span>
                    <span class="header outLinedText tbg-black">
                        -
                    </span>
                    <span class="header outLinedText tbg-purple">
                        C
                    </span>
                    <span class="header outLinedText tbg-blue">
                        L
                    </span>
                    <span class="header outLinedText tbg-green">
                        O
                    </span>
                    <span class="header outLinedText tbg-grass">
                        U
                    </span>
                    <span class="header outLinedText tbg-yellow">
                        D
                    </span>
                </div>
            </div>
            <div class="userPanel left" style="flex: 1;">
                <span class="cmd fa fa-plus-square" id="newImageCmd" title="Ajouter un image" data-toggle="tooltip"
                    style="display: none;"></span>
                <span class="cmd fa fa-arrow-down-short-wide" id="sortCmd" title="Trier" data-toggle="tooltip"></span>
                <span class="cmd fa fa-magnifying-glass-plus" id="toggleSearchCmd" title="Rechercher"
                    data-toggle="tooltip"></span>
            </div>
            <div class="userPanel" id="profileContainer" style="margin-right: 15px; display: none;">
                <img class="avatar" id="user_avatar" src="./images/No_Avatar.png" alt="">
                <span class="userName" id="username">John Doe</span>
            </div>
            <div class="userPanel right" id="loggedPanel">
                <span class="cmd fa fa-address-card editUserCmd" id="modifyCmd" title="Modifier le profil"
                    data-toggle="tooltip" style="display: none;"></span>
                <span class="cmd fa fa-arrow-right-from-bracket" id="logoutCmd" title="Se déconnecter"
                    data-toggle="tooltip" style="display: none;"></span>
            </div>
            <div class="userPanel right" id="unloggedPanel">
                <span class="cmd fa fa-arrow-right-to-bracket" id="loginCmd" title="Se connecter" data-toggle="tooltip"
                    style="display: none;"></span>
                <span class="cmd fa fa-user-plus" id="registerCmd" title="S'enregistrer" data-toggle="tooltip"
                    style="display: none;"></span>
            </div>

        </div>
        <div id="search-group" class="col-md-4" style="margin: 15px auto;">
            <div class="input-group">
                <div class="input-group-btn search-panel" data-search="">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                        <span class="search_by">Filter by</span> <span class="caret"></span>
                    </button>
                    <ul id="userSort" class="dropdown-menu" role="menu" style="max-height: 500px; overflow-y: auto;">
                        <li><a data-search="">Tous les usagers</a></li>
                        <li><a id="connectedUserLi" data-search="you">Vos images</a></li>
                        <li class="divider"></li>

                    </ul>
                </div>
                <input id="search-bar" type="search" list="search-history" class="form-control"
                    placeholder="Rechercher mot-clé...">
                <span class="input-group-btn">
                    <button id="searchCmd" class="btn btn-default" type="button"><span
                            class="glyphicon glyphicon-search"></span></button>
                </span>
            </div>
        </div>
        <datalist id="search-history">
            <option value="HTML">
        </datalist>
        <div class="scrollContainer">
            <div id="imagesList">
                <!-- filled programmatically-->
            </div>
        </div>
        <div>
            <div id="imageDlg">
                <form id="imageForm">
                    <input type="hidden" id="Id_input" value="0">
                    <input type="hidden" id="date_input" value="0">
                    <input type="hidden" id="GUID_input" value="">

                    <label for="title_input">Titre</label>
                    <input type="text" id="title_input" class="form-control" required>

                    <label for="decription_input">Description</label>
                    <textarea id="description_input" class="form-control" required></textarea>

                    <label for="image">Image</label>
                    <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                        waitingImage='images/writing.gif'>
                    </div>
                    <div class="note">Cliquez-Déposez une image</div>
                    <label for="partage">Partager</label>
                    <input type="checkbox" name="partage" id="partage">
                </form>
            </div>

            <div id="confirmDeleteDlg">
                <span id="confirmationMessage"></span>
            </div>
            <div id="errorDlg">
                <span id="errorMessage"></span>
            </div>
        </div>
        <div>
            <div id="registerDlg">
                <form id="registerForm">
                    <input type="hidden" id="userId_input" value="0">
                    <input type="hidden" id="userGUID_input" value="">

                    <label for="name_input">Nom d'usager</label>
                    <input type="text" id="name_input" class="form-control" required>

                    <label for="email_input">Courriel</label>
                    <input id="email_input" class="form-control" required>

                    <label for="password_input">Mot de passe</label>
                    <input id="password_input" class="form-control" required>

                    <label for="confirmation_input">Confirmation</label>
                    <input id="confirmation_input" class="form-control" required>

                    <label for="avatar">Avatar</label>
                    <div id='avatar' class='ImageUploader' defaultImage='images/No_Avatar.png'
                        waitingImage='images/writing.gif'>
                    </div>
                    <div class="note">Cliquez-Déposez votre avatar</div>
                </form>
            </div>
        </div>
        <div>
            <div id="loginDlg">
                <form id="loginForm">

                    <label for="login-email_input">Courriel</label>
                    <input id="login-email_input" class="form-control" required>

                    <label for="login-password_input">Mot de passe</label>
                    <input id="login-password_input" class="form-control" required>
                    <br>
                    <input type="checkbox" value="" id="remember-input">
                    <label for="remember-input">Se souvenir</label>
                    <!-- <input type="checkbox" class="form-control" id="remember_input">
                    <label for="remember_input">Se souvenir</label> -->
                </form>
            </div>
        </div>
        <div>
            <div id="areyousureDlg">
                Voulez-vous vraiment effacer votre compte ?
            </div>
        </div>

        <div>
            <div id="aboutDlg"
                style="display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <br>
                <h1>Antony Collin-Desrochers</h1>
                <br>
                <h1>David Bérubé</h1>
            </div>
            <div>
                <div id="confirmationDlg">
                    <form id="confirmationForm">
                        Consultez votre boite de courriel pour connaitre votre code de vérification et inscrivez le
                        ci-dessous :)
                        <br>
                        <label for="verify_input">Code de vérification</label>
                        <input id="verify_input" class="form-control" required>
                    </form>

                </div>
            </div>
        </div>
        <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="js/customValidation.js"></script>
        <script src="js/imageUploader.js"></script>
        <script src="js/api.js"></script>
        <script src="js/date.js"></script>
        <script defer>
            const periodicRefreshPeriod = 15;
            let holdCheckETag = false;
            let currentETag = "";
            let createMode = true;
            let searchCategory = "";
            let searchTitle = "";
            let hideSearchBar = true;
            let imageIdToDelete = 0; // used by confirmDeleteDlg
            let selectedCategory = "";
            let imagesCount = 50;
            let appendCount = 3;
            let previousScrollPosition = 0;
            let appendMode = false;
            let currentUser;
            let userFilters = [];
            let m_user = null;
            let m_refresh = false;
            let dropdown = $("#userSort");
            // GET_ALL((images) => {
            //     let sharedUsers = [];
            //     for (let image of images) {
            //         GET_UserInfo(image.UserId, (user) => {
            //             if (image.Shared) {
            //                 let newLiElement = $("<li></li>");
            //                 let newAElement = $("<a></a>").text(user.Name).attr("data-search", user.Id);
            //                 newLiElement.append(newAElement);
            //                 dropdown.append(newLiElement);
            //             }
            //         }, error)
            //     }
            //     init_Filter();
            // }, error);
            //
            init_userFilter();
            init_UI();
            init_Header();
            $("#sortCmd").click(e => { sortImages() });
            $("#toggleSearchCmd").click(() => {
                $("#search-group").slideToggle(200, getImagesList);
            });
            $("#searchCmd").click(() => {
                let keywordHistory = localStorage.getItem("keyword history");
                let searchBar = $("#search-bar");
                if (searchBar.val().trim()) {
                    if (keywordHistory !== null) {
                        let storedKeywords = JSON.parse(keywordHistory);
                        if (!storedKeywords.includes(searchBar.val())) {
                            storedKeywords.push(searchBar.val());
                            localStorage.setItem("keyword history", JSON.stringify(storedKeywords));
                        }
                    }
                    else {
                        localStorage.setItem("keyword history", JSON.stringify([searchBar.val()]))
                    }
                }
                init_searchDataList();
                getImagesList();
            })
            function init_searchDataList() {
                let keywordHistory = localStorage.getItem("keyword history");
                let searchHistoryList = $("#search-history");
                if (keywordHistory !== null) {
                    searchHistoryList.empty();
                    let storedKeywords = JSON.parse(keywordHistory);
                    for (let keyword of storedKeywords) {
                        let newOption = $("<option>").val(keyword);
                        searchHistoryList.append(newOption);
                    }
                }
            }
            init_searchDataList();
            initRegisterDlg();
            initLoginForm();
            initSureDlg();
            init_About();
            initLogout();
            initConfirmationDlg();
            HEAD(checkETag, error);
            setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);

            function checkETag(ETag) {
                if (!holdCheckETag && ETag != currentETag) {
                    currentETag = ETag;
                    sortImages();
                }
            }

            function getImagesList(refresh = true) {
                appendMode = !refresh;
                function prepareQueryString() {
                    //queryString = `?sort=Date,${asc ? "asc" : "desc"}`;
                    let queryString = "";
                    let searchBar = $("#search-bar");
                    if (appendMode) {
                        queryString = `?sort=Date,${asc ? "asc" : "desc"}&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}&Title=${$("#search-group").is(":visible") ? searchBar.val() : ""}&UserId=${$('.search-panel').data("search")}`;
                        imagesCount += appendCount;
                    } else {
                        queryString = `?sort=Date,${asc ? "asc" : "desc"}&offset=${0}&limit=${imagesCount}&Title=${$("#search-group").is(":visible") ? searchBar.val() : ""}&UserId=${$('.search-panel').data("search")}`;
                    }
                    return queryString;
                }
                GET_ALL(refreshimagesList, error, prepareQueryString());
            }

            function ImSure() {
                $("#areyousureDlg").dialog('option', 'title', "Attention !");
                $("#yousureDlgOkBtn").text("Désinscire mon compte");
                $("#areyousureDlg").dialog('open');
            }

            function getUsersList(refresh = true) {
                // appendMode = !refresh;
                // function prepareQueryString() {
                //     let queryString = "";
                //     if (appendMode) {
                //         queryString = `accounts`;
                //         //magesCount += appendCount;
                //     } else {
                //         queryString = `?sort=Date,desc&offset=${0}&limit=${imagesCount}`;
                //     }
                //     return queryString;
                // }
                // //GET_ALL(refreshimagesList, error, prepareQueryString());
            }
            function refreshimagesList(images, ETag) {
                function insertIntoImageList(image) {

                    $("#imagesList").append(
                        $(` 
                                <div class='imageLayout'>
                                    <div class='imageHeader'>
                                        <div class="imageTitle">${image.Title}</div>
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip"
                                                style='${image.UserId == retrieveLoggedUser().Id ? "" : "display:none;"}'>
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip"
                                                style='${image.UserId == retrieveLoggedUser().Id ? "" : "display:none;"}'>
                                        </div>
                                    </div>
                                    <a href="${image.OriginalURL}" target="_blank">
                                        <div    class='image' 
                                                style="background-image:url('${image.ThumbnailURL}')">
                                        </div>
                                    </a>                                                                                                         
                                    <img style='width:50px;heigth:50px; position:relative; top:-200px; left:10px' src=${m_user == null ? "" : image.Shared && image.UserId != m_user.Id ? "" : image.Shared && image.UserId == m_user.Id ? "images/shared.png" : "images/private.png"}>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                    );
                }
                currentETag = ETag;
                previousScrollPosition = $(".scrollContainer").scrollTop();
                if (!appendMode) $("#imagesList").empty();

                if (appendMode && images.length == 0)
                    imagesCount -= appendCount;

                for (let image of images) {

                    if (retrieveLoggedUser() == null) {
                        if (image.Shared) {
                            insertIntoImageList(image);
                        }
                    }
                    else {
                        if (image.Shared || image.UserId == retrieveLoggedUser().Id)
                            insertIntoImageList(image);
                    }
                }

                $(".scrollContainer").scrollTop(previousScrollPosition);
                $(".editCmd").off();
                $(".deleteCmd").off();
                $(".showMore").off();
                $(".editCmd").click(e => { editimage(e) });
                $(".editUserCmd").click(e => { ModifyUser() });
                $(".deleteCmd").click(e => { deleteimage(e) });

                $('[data-toggle="tooltip"]').tooltip();
            }

            function error(status) {
                let errorMessage = "";
                switch (status) {
                    case 0:
                        errorMessage = "Le service ne répond pas";
                        break;
                    case 401:
                        errorMessage = "Requête non autorisée";
                        break;
                    case 400:
                    case 422:
                        errorMessage = "Requête invalide";
                        break;
                    case 404:
                        errorMessage = "Service ou données introuvables";
                        break;
                    case 409:
                        errorMessage = "Conflits de données: Hyperlien existe déjà";
                        break;
                    case 500:
                        errorMessage = "Erreur interne du service";
                        break;
                    default:
                        errorMessage = "Une erreur est survenue";
                        break;
                }
                $("#errorMessage").text(errorMessage);
                $("#errorDlg").dialog('open');
            }

            function newImage() {
                holdCheckETag = true;
                createMode = true;
                resetimageForm();
                ImageUploader.imageRequired('image', true);
                $("#imageDlg").dialog('option', 'title', "Ajout d'image");
                $("#imageDlgOkBtn").text("Ajouter");
                $("#imageDlg").dialog('open');
            }

            function Register() {
                $("#deleteAccountBtn").hide();
                holdCheckETag = true;
                createMode = true;
                resetRegisterForm();
                //ImageUploader.imageRequired('image', true);
                $("#registerDlg").dialog('option', 'title', "Création de compte");
                $("#registerDlgOkBtn").text("Créer");
                $("#registerDlg").dialog('open');
            }

            function ModifyUser() {
                holdCheckETag = true;
                createMode = false;
                // user to form

                userToForm(retrieveLoggedUser());
                holdCheckETag = true;

                $("#registerDlg").dialog('option', 'title', "Modification de profil");
                $("#registerDlgOkBtn").text("Modifier");
                $("#registerDlg").dialog('open');
                $("#avatar_ImageContainer").attr("style", `background-image:url(${retrieveLoggedUser().AvatarURL});; background-position: center center; background-size: contain; background-repeat: no-repeat; flex: 1 1 0%; height: 100%; width: 100%;"`);

                // holdCheckETag = true;
                // createMode = false;
                // GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                // holdCheckETag = true;
                // ImageUploader.imageRequired('image', false);
                // $("#imageDlg").dialog('option', 'title', "Modification d'image");
                // $("#imageDlgOkBtn").text("Modifier");
                // $("#imageDlg").dialog('open');
            }



            function editimage(e) {
                holdCheckETag = true;
                createMode = false;
                GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
                holdCheckETag = true;
                ImageUploader.imageRequired('image', false);
                $("#imageDlg").dialog('option', 'title', "Modification d'image");
                $("#imageDlgOkBtn").text("Modifier");
                $("#imageDlg").dialog('open');
            }

            function Confirmation() {
                if (createMode) {
                    holdCheckETag = true;
                    //createMode = true;
                    //resetRegisterForm();
                    //ImageUploader.imageRequired('image', true);
                    $("#confirmationDlg").dialog('option', 'title', "Vérification de courriel");
                    $("#confirmationDlgOkBtn").text("Envoyer");
                    $("#confirmationDlg").dialog('open');
                }
            }
            function Login() {
                holdCheckETag = true;
                createMode = false;
                resetLoginForm();
                $("#loginDlg").dialog('option', 'title', "Connexion");
                $("#loginDlgOkBtn").text("Connexion");
                $("#loginDlg").dialog('open');
            }

            function deleteimage(e) {
                holdCheckETag = true;
                imageIdToDelete = e.target.getAttribute("imageid");
                GET_ID(
                    imageIdToDelete,
                    image => {
                        $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                    },
                    error
                );
                holdCheckETag = true;
                $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
                $("#confirmDeleteDlgOkBtn").text("Effacer");
                $("#confirmDeleteDlg").dialog('open');
            }
            function resetimageForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("");
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                ImageUploader.resetImage('image');
            }


            function resetLoginForm() {
                //To Define
            }
            function imageFromForm() {
                if ($("#imageForm")[0].checkValidity()) {
                    let image = {
                        Id: parseInt($("#Id_input").val()),
                        GUID: $("#GUID_input").val(),
                        Title: $("#title_input").val(),
                        Description: $("#description_input").val(),
                        ImageData: ImageUploader.getImageData('image'),
                        Date: parseInt($("#date_input").val()),
                        Shared: $("#partage").is(':checked'),
                        UserId: retrieveLoggedUser().Id
                    };
                    return image;
                } else {
                    $("#imageForm")[0].reportValidity()
                }
                return false;
            }
            function imageToForm(image) {
                $("#Id_input").val(image.Id);
                $("#GUID_input").val(image.GUID);
                $("#date_input").val(image.Date);
                //$("#date_input").val(Date.now());
                $("#title_input").val(image.Title);
                $("#description_input").val(image.Description);
                $("#partage").prop('checked', image.Shared);

                $("#partage").val(image.Shared);
                ImageUploader.setImage('image', image.OriginalURL);
            }
            function resetRegisterForm() {
                $("#Id_input").val("0");
                $("#GUID_input").val("");
                $("#date_input").val(Date.now());
                $("#title_input").val("");
                $("#description_input").val("");
                ImageUploader.resetImage('image');
            }
            function userRegisterFromForm() {
                if ($("#registerForm")[0].checkValidity()) {
                    let user = {
                        Id: parseInt($("#userId_input").val()),
                        Name: $("#name_input").val(),
                        Email: $("#email_input").val(),
                        Password: $("#password_input").val(),
                        AvatarGUID: $("#userGUID_input").val(),
                        ImageData: ImageUploader.getImageData('avatar'),
                        Date: parseInt($("#date_input").val())
                    };
                    return user;
                } else {
                    $("#registerForm")[0].reportValidity()
                }
                return false;
            }

            function userToForm(user) {
                $("#userId_input").val(user.Id);
                $("#name_input").val(user.Name);
                $("#email_input").val(user.Email);
                $("#password_input").val(user.Password);
                $("#userGUID_input").val(user.AvatarGUID);
                ImageUploader.resetImage('image');
                $("#date_input").val(user.Date);
                //$("#avatar_input").val(user.AvatarGUID);

                console.log(user.Id);

                //ImageUploader.setImage('image', image.OriginalURL);
            }

            function userLoginFromForm() {
                if ($("#loginForm")[0].checkValidity()) {
                    let loginInfo = {
                        Email: $("#login-email_input").val(),
                        Password: $("#login-password_input").val(),
                    };
                    return loginInfo;
                } else {
                    $("#loginForm")[0].reportValidity()
                }
                return false;
            }

            let asc = true;
            function sortImages() {
                asc = !asc;
                let ascIconClass = "fa-arrow-down-short-wide";
                let descIconClass = "fa-arrow-up-short-wide";
                if (asc) {
                    $("#sortCmd").attr("title", "Trier descendant");
                    $("#sortCmd").addClass(ascIconClass);
                    $("#sortCmd").removeClass(descIconClass);
                }
                else {
                    $("#sortCmd").attr("title", "Trier ascendant");
                    $("#sortCmd").removeClass(ascIconClass);
                    $("#sortCmd").addClass(descIconClass);
                }
                $("#sortCmd").mouseout();
                $("#sortCmd").mouseenter();

                // console.log(e);
                getImagesList();
                // console.log("yop");


                //     let queryString = "";

                //         queryString = `?sort=Date,${asc ? "asc" : "desc"}`;
                //         console.log(queryString);
                //         //imagesCount += appendCount;

                //         //queryString = `?sort=Date,desc&offset=${0}&limit=${imagesCount}`;

                //    // return queryString;

                // GET_ALL(refreshimagesList, error, queryString);
            }

            function userFromModify() {
                let user = {
                    Id: parseInt($("#userId_input").val()),
                    Name: $("#name_input").val(),
                    Email: $("#email_input").val(),
                    Password: $("#password_input").val(),
                    ImageData: ImageUploader.getImageData('avatar'),
                    //ImageData: ImageUploader.getImageData('image'),
                    //Date: parseInt($("#date_input").val())
                };
                //ImageUploader.getImageData('avatar');
                return user;
            }

            //userLoginToForm = () => {}
            function initRegisterDlg() {
                $("#registerCmd").click(Register);
                $("#registerDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [
                        {
                            id: "deleteAccountBtn",
                            text: "Désinscrire",
                            click: function () {
                                $(this).dialog("close");
                            }
                        },
                        {
                            id: "registerDlgOkBtn",
                            text: "Title will be changed dynamically",
                            click: function () {
                                let user = userRegisterFromForm();
                                //console.log(user.Id);
                                if (createMode) {

                                    if (user) {
                                        POST_REGISTER(user, () => {
                                            init_Header();
                                        }, error);
                                    }
                                }
                                else // modify
                                {
                                    let user = userFromModify();
                                    //console.log(user.Id);


                                    modify_UserInfo(user, () => {
                                        init_Header();
                                    }, error);
                                    resetRegisterForm();
                                    holdCheckETag = false;
                                    $(this).dialog("close");
                                    $("#confirmationDlg").dialog("close");
                                    $("#confirmationDlg").hide();
                                }
                            }
                        },
                        {
                            text: "Annuler",
                            click: function () {
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }]
                });
            }

            function initSureDlg() {
                $("#deleteAccountBtn").click(ImSure);
                $("#areyousureDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 300,
                    minWidth: 300,
                    maxWidth: 300,
                    height: 390,
                    minHeight: 390,
                    maxHeight: 390,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "yousureDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {

                            DELETE_USER(() => {
                                init_Header();
                                $(this).dialog("close");

                            }, error);

                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
            }

            function initConfirmationDlg() {
                $("#registerDlgOkBtn").click(Confirmation);
                $("#confirmationDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 300,
                    minWidth: 300,
                    maxWidth: 300,
                    height: 390,
                    minHeight: 390,
                    maxHeight: 390,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmationDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            //placeholder
                            GET_VERIFY(parseInt($("#verify_input").val()), () => {

                                // login
                                //parseInt($("#date_input").val());
                                $(this).dialog("close");

                            }, error);


                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
            }
            function initLogout() {
                $("#logoutCmd").click(() => {
                    let userInfo = retrieveLoggedUser();
                    if (userInfo) {
                        logout(userInfo.Id, (() => {
                            init_userFilter();
                            getImagesList();
                            init_Header();
                            console.log("Disconnected");
                        }), error);
                    }
                })
            }
            function initLoginForm() {
                $("#loginCmd").click(Login);
                $("#loginDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    resizable: false, //Ne peut réajuster le dialogue
                    draggable: false, //Désactive le drag du dialogue
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 300,
                    minWidth: 300,
                    maxWidth: 300,
                    height: 390,
                    minHeight: 390,
                    maxHeight: 390,
                    position: { my: "center", at: "center", of: window },
                    buttons: [{
                        id: "loginDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let loginInfo = userLoginFromForm();
                            let rememberUser = $("#remember-input").is(":checked");
                            if (loginInfo) {
                                //Remember user
                                localStorage.setItem("rememberUser", rememberUser);
                                //Log user
                                POST_LOGIN(loginInfo.Email, loginInfo.Password, () => {
                                    init_userFilter();
                                    getImagesList();
                                    init_Header();
                                    $(this).dialog("close");
                                }, error);
                            }
                            // resetRegisterForm();
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });
            }
            function init_UI() {
                $("#newImageCmd").click(newImage)

                $("#imageDlg").dialog({
                    title: "...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 640,
                    minWidth: 640,
                    maxWidth: 640,
                    height: 780,
                    minHeight: 780,
                    maxHeight: 780,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "imageDlgOkBtn",
                        text: "Title will be changed dynamically",
                        click: function () {
                            let image = imageFromForm();
                            if (image) {
                                if (createMode) {
                                    POST(image, getImagesList, error);
                                    $(".scrollContainer").scrollTop(0);
                                }
                                else
                                    PUT(image, getImagesList, error);
                                resetimageForm();
                                holdCheckETag = false;
                                $(this).dialog("close");
                            }
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#confirmDeleteDlg").dialog({
                    title: "Attention!",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        id: "confirmDeleteDlgOkBtn",
                        text: "Oui",
                        click: function () {
                            holdCheckETag = false;
                            if (imageIdToDelete)
                                DELETE(imageIdToDelete, getImagesList, error);
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: "Annuler",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $("#errorDlg").dialog({
                    title: "Erreur...",
                    autoOpen: false,
                    modal: true,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    width: 500, minWidth: 500, maxWidth: 500,
                    height: 230, minHeight: 230, maxHeight: 230,
                    position: { my: "top", at: "top", of: window },
                    buttons: [{
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            imageIdToDelete = 0;
                            $(this).dialog("close");
                        }
                    }]
                });

                $(".scrollContainer").scroll(function () {
                    if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                        getImagesList(false);
                    }
                });
                //if connected
                if (retrieveAccessToken()) {
                    $("#loggedPanel").show();
                    $("#unloggedPanel").hide();
                }

            }
            function init_Header() {
                //Image Command Icons
                $(".editCmd").click(e => { editimage(e) });
                let newImageIcon = $("#newImageCmd");
                //Search
                $("#search-group").hide();
                //User 
                let profileContainer = $("#profileContainer");
                let username = $("#username");
                let image = $("#user_avatar");
                //Command Icons
                let registerIcon = $("#registerCmd");
                let loginIcon = $("#loginCmd");
                let logoutIcon = $("#logoutCmd");
                let modifyIcon = $("#modifyCmd");
                //Hide Everything on initialization
                newImageIcon.hide();
                profileContainer.hide();
                registerIcon.hide();
                loginIcon.hide();
                logoutIcon.hide();
                modifyIcon.hide();

                //UserInfo
                m_user = retrieveLoggedUser();
                //Show depending if user info
                if (m_user) {
                    $("#connectedUserLi").attr("data-search", m_user.Id);
                    $("#connectedUserLi").show();
                    //Image Command Icon
                    newImageIcon.show();
                    //User Command Icons
                    logoutIcon.show();
                    modifyIcon.show();
                    //Profile Container
                    username.text(m_user.Name);

                    let url = m_user.AvatarURL;
                    if (url !== "" && url !== null && !url.includes("undefined")) {
                        image.attr("src", url);
                    }
                    profileContainer.show();
                }
                else {
                    $("#connectedUserLi").attr("data-search", "");
                    $("#connectedUserLi").hide();
                    loginIcon.show();
                    registerIcon.show();
                }


            }
            function init_userFilter() {
                GET_ALL((images) => {
                    let promises = [];
                    if (userFilters.length > 0) {
                        for (userFilter of userFilters) {
                            userFilter.remove();
                        }
                        userFilters = [];
                    }
                    for (let image of images) {
                        let promise = new Promise((resolve, reject) => {
                            GET_UserInfo(image.UserId, (user) => {
                                if (image.Shared) {
                                    if (m_user == null || m_user.Id != image.UserId) {
                                        let newLiElement = $("<li></li>");
                                        let newAElement = $("<a></a>").text(user.Name).attr("data-search", user.Id);
                                        userFilters.push(newLiElement.append(newAElement));
                                        dropdown.append(newLiElement);
                                    }
                                }
                                resolve();
                            }, error)
                        });
                        promises.push(promise);
                    }
                    Promise.all(promises).then(() => {
                        init_Filter();
                    });
                }, error);
            }
            function init_About() {
                $("#logo").click(() => {
                    $("#aboutDlg").dialog('open');
                });
                $("#aboutDlg").dialog({
                    title: "À propos",
                    autoOpen: false,
                    modal: true,
                    resizable: false,
                    width: "auto",
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    position: { my: "center", at: "center", of: window },
                    buttons: [
                        {
                            text: "Fermer",
                            click: function () {
                                $(this).dialog("close");
                            }
                        }]
                });
            }
            //SearchBar Filter
            $('.search-panel').each(function () {
                var to = $(this).data('search').toString();
                var text = $(this).find('[data-search="' + to + '"]').html();
                $(this).find('button span.search_by').html(text);
            });
            function init_Filter() {
                $('.search-panel li a').on('click', function (e) {
                    var sp = $(this).closest('.search-panel');
                    var to = $(this).attr("data-search");
                    var text = $(this).html();
                    sp.data('search', to);
                    console.log(sp.find('.search_by'));
                    sp.find('button span.search_by').html(text);
                    getImagesList();
                });
            }
        </script>
</body>

</html>